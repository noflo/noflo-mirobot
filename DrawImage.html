<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>DrawImage</title>
    <script src="http://cdn.rawgit.com/rtc-io/rtc/v3.1.1/dist/rtc.js"></script>
    <script src="noflo-mirobot.js"></script>
  </head>
  <body>
    <a id='flowhub_debug_url'>Debug in Flowhub</a>
    <canvas id="c" width="400" height="400"></canvas>
    <script>
      var noflo = require('noflo');
      var runtime = require('noflo-runtime-webrtc');

      function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        var results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      noflo.graph.loadJSON(require('noflo-mirobot/graphs/DrawImage.json'), function (graph) {
        graph.baseDir = '/noflo-mirobot';

        var queryProtocol = getParameterByName('fbp_protocol');
        var queryAddress = getParameterByName('fbp_address');
        var queryNoLoad = getParameterByName('fbp_noload');

        var runtimeOptions = {
            baseDir: graph.baseDir
        };
        if (queryNoLoad.toLowerCase() !== 'true') {
            runtimeOptions.defaultGraph = graph;
        };

        var rt = null;
        if (queryProtocol == 'webrtc' && queryAddress) {
            // ID to use specified from outside, normally by Flowhub IDE
            var rt = runtime(queryAddress, runtimeOptions, true);
        } else {
            // Generate new ID
            var rt = runtime(null, runtimeOptions, true);
            rt.signaller = 'http://flowhub-rtc.herokuapp.com';
        }

        rt.debug = true; // TEMP

        rt.start();
        var ide = 'http://localhost:8000/index.html';
        var debugUrl = ide+'#runtime/endpoint?'+encodeURIComponent('protocol=webrtc&address='+rt.signaller+'#'+rt.id);
        console.log('Debug URL', debugUrl);
        document.getElementById('flowhub_debug_url').href = debugUrl;

        rt.network.on('addnetwork', function () {
            console.log('DrawImage is running!');
        });
      });
    </script>
  </body>
</html>
